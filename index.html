<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>High Quality Discord Clone</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --text-normal: #dcddde;
            --accent: #5865f2;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-normal); overflow: hidden; display: flex; height: 100vh; }

        /* --- UI COMPONENT: LOGIN --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box { background: var(--bg-secondary); padding: 30px; border-radius: 8px; width: 100%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; background: var(--bg-tertiary); border: none; color: white; border-radius: 4px; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 16px;}
        .btn-blue { background: var(--accent); }
        .btn-gray { background: #4f545c; }

        /* --- UI COMPONENT: MAIN LAYOUT --- */
        /* Sidebar (Desktop default) */
        .sidebar { 
            width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; flex-shrink: 0; 
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        /* Mobile Header (Hidden on Desktop) */
        .mobile-header {
            display: none; height: 50px; background: var(--bg-tertiary); align-items: center; padding: 0 15px; border-bottom: 1px solid #202225;
        }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative; min-width: 0; height: 100%; }

        /* --- VIDEO GRID --- */
        .video-grid {
            display: flex; gap: 10px; padding: 10px; background: black; overflow-x: auto; 
            min-height: 0px; height: 0px; transition: height 0.3s; border-bottom: 1px solid #202225;
        }
        .video-grid.show { height: 35vh; min-height: 200px; } /* Занимает 35% экрана */

        .video-card {
            position: relative; height: 100%; aspect-ratio: 16/9; background: #202225; border-radius: 8px; overflow: hidden; flex-shrink: 0; border: 1px solid #444; cursor: pointer;
        }
        .video-card video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .video-label { 
            position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; 
            padding: 4px 8px; font-size: 12px; border-radius: 4px; pointer-events: none; 
        }
        .fullscreen-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); color: white; padding: 10px; border-radius: 5px;
            opacity: 0; transition: opacity 0.2s; pointer-events: none; font-size: 12px; text-align: center;
        }
        .video-card:hover .fullscreen-hint { opacity: 1; }

        /* --- CHAT AREA --- */
        .messages-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .message { display: flex; margin-bottom: 5px; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; background: #5865f2; flex-shrink: 0;}
        .msg-header { margin-bottom: 2px; }
        .msg-username { font-weight: bold; margin-right: 6px; cursor: pointer; font-size: 15px;}
        .msg-text { color: #dcddde; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4; font-size: 15px; }
        .msg-time { font-size: 11px; color: #72767d; }

        /* --- INPUT AREA --- */
        .input-area { padding: 15px; background: var(--bg-primary); }
        .input-wrapper { background: #40444b; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; }
        .chat-input { background: transparent; border: none; color: white; width: 100%; height: 48px; outline: none; font-size: 16px;}

        /* --- CONTROLS (BOTTOM LEFT) --- */
        .user-panel { background: #292b2f; padding: 10px; display: flex; align-items: center; margin-top: auto; justify-content: space-between; }
        .control-group { display: flex; gap: 8px; }
        .control-btn { 
            background: #202225; border: none; color: var(--text-normal); cursor: pointer; 
            width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;
            transition: 0.2s;
        }
        .control-btn:active { transform: scale(0.95); }
        .control-btn.active { background: var(--success); color: white; }
        .control-btn.disabled { color: var(--danger); position: relative; }
        .control-btn.disabled::after { content: ''; position: absolute; width: 100%; height: 2px; background: var(--danger); top: 50%; left: 0; transform: rotate(45deg); }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            
            /* Скрываем сайдбар по умолчанию на мобилках */
            .sidebar { 
                position: absolute; top: 0; left: 0; height: 100%; width: 80%; 
                transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); }
            
            /* Overlay when sidebar is open */
            .sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 90;
            }
            .sidebar-overlay.show { display: block; }

            .video-grid.show { height: 250px; } /* На телефоне видео чуть меньше */
            .video-card { width: 80vw; } /* Одна карточка почти во весь экран */
            
            .msg-text { font-size: 16px; } /* Текст крупнее для чтения */
            .input-area { padding: 10px; }
        }

    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: white; margin-bottom: 10px;">Discord HD</h2>
            <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">Двойной тап по видео = Полный экран</p>
            <input type="text" id="usernameInput" class="login-input" placeholder="Твой никнейм">
            <button class="btn btn-blue" onclick="createRoom()">Создать комнату</button>
            <div style="margin: 15px 0; color: #72767d; font-size: 14px;">— ИЛИ —</div>
            <input type="text" id="joinCodeInput" class="login-input" placeholder="Код комнаты...">
            <button class="btn btn-gray" onclick="joinRoom()">Присоединиться</button>
        </div>
    </div>

    <div class="mobile-header">
        <button class="control-btn" style="background:none;" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <span style="font-weight: bold; margin-left: 10px;">Групповой чат</span>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding: 20px; font-weight: bold; border-bottom: 1px solid #202225; display: flex; justify-content: space-between;">
            <span>Участники</span>
            <i class="fas fa-times" style="cursor:pointer; display:none;" onclick="toggleSidebar()" id="closeMenuBtn"></i>
        </div>
        
        <div style="flex:1; padding: 10px; color: #72767d; overflow-y: auto;" id="userList"></div>
        
        <div style="padding: 15px; background: #202225; text-align: center; border-top: 1px solid #2f3136;">
             <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">ID КОМНАТЫ:</div>
             <span id="myIdDisplay" style="font-family: monospace; cursor: pointer; color: var(--accent); font-size: 14px; font-weight: bold;" onclick="copyCode()">Нажми, чтобы скопировать</span>
        </div>

        <div class="user-panel">
            <div style="font-weight:bold; font-size:14px; color: white; white-space: nowrap; overflow: hidden; max-width: 80px;" id="myDisplayName">User</div>
            <div class="control-group">
                <button class="control-btn disabled" id="btnMic" onclick="toggleMic()">
                    <i class="fas fa-microphone-slash"></i>
                </button>
                <button class="control-btn disabled" id="btnScreen" onclick="toggleScreen()">
                    <i class="fas fa-desktop"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="chat-main">
        <div class="video-grid" id="videoGrid"></div>

        <div class="messages-area" id="messagesArea">
            <div style="margin-top: auto; text-align: center; color: #72767d; padding: 20px;">
                <p>Начните общение или включите демонстрацию экрана.</p>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="chatInput" class="chat-input" placeholder="Сообщение..." autocomplete="off">
                <i class="fas fa-paper-plane" style="color: var(--accent); cursor: pointer; padding: 10px;" onclick="sendMessage()"></i>
            </div>
        </div>
    </div>

    <script>
        let peer;
        let myId;
        let myName;
        let isHost = false;
        let dataConnections = []; 
        let hostConn = null; 
        let localAudioStream = null;
        let localScreenStream = null;
        let currentCalls = [];

        /* --- MOBILE UI LOGIC --- */
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const closeBtn = document.getElementById('closeMenuBtn');
            
            sb.classList.toggle('open');
            overlay.classList.toggle('show');
            
            // Show close X only on mobile
            if(window.innerWidth <= 768) {
                closeBtn.style.display = sb.classList.contains('open') ? 'block' : 'none';
            }
        }

        /* --- P2P CORE --- */
        function initPeer() {
            myName = document.getElementById('usernameInput').value || "User";
            return new Peer(); 
        }

        function createRoom() {
            if(!document.getElementById('usernameInput').value) return alert("Введите имя!");
            peer = initPeer();
            peer.on('open', (id) => {
                myId = id; isHost = true; enterApp();
                addToUserList(myName + " (Вы)");
            });
            peer.on('connection', (conn) => setupDataConnection(conn));
            peer.on('call', handleIncomingCall);
        }

        function joinRoom() {
            const hostId = document.getElementById('joinCodeInput').value;
            if(!document.getElementById('usernameInput').value || !hostId) return alert("Введите данные!");
            peer = initPeer();
            peer.on('open', (id) => {
                myId = id; isHost = false; enterApp();
                hostConn = peer.connect(hostId, { metadata: { name: myName } });
                hostConn.on('open', () => {
                    addToUserList(myName + " (Вы)");
                });
                hostConn.on('data', handleData);
            });
            peer.on('call', handleIncomingCall);
        }

        function enterApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('myIdDisplay').innerText = myId;
            document.getElementById('myDisplayName').innerText = myName;
        }

        /* --- CHAT LOGIC --- */
        function setupDataConnection(conn) {
            dataConnections.push(conn);
            conn.on('open', () => {
                broadcast({ type: 'system', text: `${conn.metadata.name} присоединился` });
                // Отправляем новому юзеру список текущих участников (простая реализация)
            });
            conn.on('data', (data) => { handleData(data); broadcast(data); });
            conn.on('close', () => { dataConnections = dataConnections.filter(c => c !== conn); });
        }

        function broadcast(data) { dataConnections.forEach(c => c.send(data)); }

        function handleData(data) {
            if (data.type === 'chat') {
                if (data.sender === myName) return;
                addMessageToUI(data.sender, data.text);
            } else if (data.type === 'system') {
                addSystemMsg(data.text);
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            const msg = { type: 'chat', sender: myName, text: text };
            addMessageToUI(myName, text); 
            if(isHost) broadcast(msg); else if(hostConn) hostConn.send(msg);
            input.value = '';
        }

        /* --- MEDIA: SCREEN & AUDIO --- */
        
        function handleIncomingCall(call) {
            call.answer();
            call.on('stream', (remoteStream) => {
                if(remoteStream.getVideoTracks().length > 0) {
                    addVideoCard(remoteStream, call.peer); // Экран
                } else {
                    playAudio(remoteStream); // Голос
                }
            });
        }

        async function toggleMic() {
            const btn = document.getElementById('btnMic');
            if (localAudioStream) {
                localAudioStream.getTracks().forEach(t => t.stop());
                localAudioStream = null;
                btn.className = "control-btn disabled";
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                closeAllCalls();
            } else {
                try {
                    localAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    btn.className = "control-btn active";
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    callEveryone(localAudioStream);
                } catch(e) { alert("Нет доступа к микрофону"); }
            }
        }

        async function toggleScreen() {
            const btn = document.getElementById('btnScreen');
            if (localScreenStream) {
                stopScreenShare();
            } else {
                try {
                    // --- HIGH QUALITY SETTINGS ---
                    localScreenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { 
                            width: { ideal: 1920, max: 3840 }, // Просим Full HD или 4K
                            height: { ideal: 1080, max: 2160 },
                            frameRate: { ideal: 60 } // Просим 60 FPS
                        }, 
                        audio: true 
                    });
                    
                    btn.className = "control-btn active";
                    addVideoCard(localScreenStream, "Me"); // Себе
                    callEveryone(localScreenStream); // Другим
                    
                    localScreenStream.getVideoTracks()[0].onended = stopScreenShare;
                } catch(e) { console.error(e); }
            }
        }

        function stopScreenShare() {
            if(!localScreenStream) return;
            localScreenStream.getTracks().forEach(t => t.stop());
            localScreenStream = null;
            document.getElementById('btnScreen').className = "control-btn disabled";
            const myVid = document.getElementById('vid-Me');
            if(myVid) myVid.remove();
            checkGridEmpty();
            closeAllCalls();
            if(localAudioStream) callEveryone(localAudioStream); // Возвращаем голос если был
        }

        function callEveryone(stream) {
            if (isHost) {
                dataConnections.forEach(conn => currentCalls.push(peer.call(conn.peer, stream)));
            } else if(hostConn) {
                currentCalls.push(peer.call(hostConn.peer, stream));
            }
        }

        function closeAllCalls() {
            currentCalls.forEach(call => call.close());
            currentCalls = [];
        }

        /* --- VIDEO UI --- */
        function addVideoCard(stream, peerId) {
            const grid = document.getElementById('videoGrid');
            grid.classList.add('show');
            if(document.getElementById(`vid-${peerId}`)) return;

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `vid-${peerId}`;
            
            // Двойной клик для полного экрана
            card.ondblclick = () => toggleFullscreen(card.querySelector('video'));

            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.playsInline = true;
            if(peerId === "Me") vid.muted = true;

            const label = document.createElement('div');
            label.className = 'video-label';
            label.innerText = peerId === "Me" ? "Вы (Экран)" : "Экран собеседника";

            const hint = document.createElement('div');
            hint.className = 'fullscreen-hint';
            hint.innerHTML = '<i class="fas fa-expand"></i><br>2 клика';

            card.appendChild(vid);
            card.appendChild(label);
            card.appendChild(hint);
            grid.appendChild(card);
        }

        // Логика полного экрана
        function toggleFullscreen(videoElem) {
            if (!document.fullscreenElement) {
                videoElem.requestFullscreen().catch(err => {
                    alert(`Ошибка: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function playAudio(stream) {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();
        }

        function checkGridEmpty() {
            const grid = document.getElementById('videoGrid');
            if(grid.children.length === 0) grid.classList.remove('show');
        }

        /* --- UTILS --- */
        function addMessageToUI(sender, text) {
            const area = document.getElementById('messagesArea');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <div class="msg-avatar" style="background: ${stringToColor(sender)}"></div>
                <div>
                    <div class="msg-header">
                        <span class="msg-username">${sender}</span>
                        <span class="msg-time">${new Date().toLocaleTimeString().slice(0,5)}</span>
                    </div>
                    <div class="msg-text">${text}</div>
                </div>
            `;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function addSystemMsg(text) {
            document.getElementById('messagesArea').innerHTML += `<div style="color:#72767d; font-size:12px; margin:10px 0; text-align:center;">${text}</div>`;
        }

        function addToUserList(name) {
            const list = document.getElementById('userList');
            list.innerHTML += `<div style="margin-bottom:8px; display:flex; align-items:center;"><i class="fas fa-user-circle" style="margin-right:8px;"></i> ${name}</div>`;
        }

        function copyCode() {
            navigator.clipboard.writeText(myId);
            alert("Скопировано! Отправь другу.");
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return '#' + '00000'.substring(0, 6 - (hash & 0x00FFFFFF).toString(16).toUpperCase().length) + (hash & 0x00FFFFFF).toString(16).toUpperCase();
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
