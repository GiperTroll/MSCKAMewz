<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord - Text & Screen</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --text-normal: #dcddde;
            --accent: #5865f2;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-normal); overflow: hidden; display: flex; height: 100vh; }

        /* --- ВХОД --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: var(--bg-secondary); padding: 40px; border-radius: 8px; width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-tertiary); border: none; color: white; border-radius: 3px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 3px; color: white; cursor: pointer; margin-top: 10px; font-weight: bold;}
        .btn-blue { background: var(--accent); } .btn-blue:hover { background: #4752c4; }
        .btn-gray { background: #4f545c; }

        /* --- UI --- */
        .sidebar { width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; flex-shrink: 0;}
        .user-panel { background: #292b2f; padding: 10px; display: flex; align-items: center; margin-top: auto; }
        
        .control-btn { 
            background: #202225; border: none; color: var(--text-normal); cursor: pointer; 
            padding: 10px; font-size: 16px; border-radius: 50%; margin-left: 5px; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .control-btn:hover { background: #3f4147; }
        
        /* Кнопка выключена (красная полоска) */
        .control-btn.disabled { position: relative; color: var(--danger); }
        .control-btn.disabled::after { content: ''; position: absolute; width: 100%; height: 2px; background: var(--danger); top: 50%; left: 0; transform: rotate(45deg); }
        
        /* Кнопка включена (зеленая) */
        .control-btn.active { background: var(--success); color: white; }
        .control-btn.active:hover { background: #3ba55c; }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative; min-width: 0;}
        
        /* Видео сетка (Экран) */
        .video-grid {
            display: flex; gap: 10px; padding: 10px; background: black; overflow-x: auto; 
            min-height: 0px; height: 0px; transition: height 0.3s;
            border-bottom: 1px solid #202225;
        }
        .video-grid.show { height: 200px; min-height: 200px; }

        .video-card {
            position: relative; width: 300px; height: 100%; background: #202225; border-radius: 8px; overflow: hidden; flex-shrink: 0; border: 1px solid #444;
        }
        .video-card video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .video-name { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; font-size: 12px; border-radius: 4px; }

        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { display: flex; margin-bottom: 5px; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background: #5865f2; flex-shrink: 0;}
        .msg-header { margin-bottom: 2px; }
        .msg-username { font-weight: bold; margin-right: 5px; cursor: pointer; }
        .msg-text { color: #dcddde; word-wrap: break-word; white-space: pre-wrap; }

        .input-area { padding: 20px; background: var(--bg-primary); }
        .input-wrapper { background: #40444b; border-radius: 8px; padding: 0 15px; display: flex; align-items: center; }
        .chat-input { background: transparent; border: none; color: white; width: 100%; height: 44px; outline: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: white;">Чат + Экран</h2>
            <p style="color: #aaa; font-size: 13px;">Введите ник. Доступ к микр/экрану нужен только если захотите включить их.</p>
            <input type="text" id="usernameInput" class="login-input" placeholder="Твой никнейм">
            <button class="btn btn-blue" onclick="createRoom()">Создать комнату</button>
            <p style="margin: 10px 0; color: #72767d;">— ИЛИ —</p>
            <input type="text" id="joinCodeInput" class="login-input" placeholder="Код комнаты...">
            <button class="btn btn-gray" onclick="joinRoom()">Присоединиться</button>
        </div>
    </div>

    <div class="sidebar">
        <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #202225;">Участники</div>
        <div style="flex:1; padding: 10px; color: #72767d; font-size: 14px;" id="userList"></div>
        
        <div style="padding: 10px; background: #202225; text-align: center;">
             <span id="myIdDisplay" style="font-family: monospace; cursor: pointer; color: var(--accent); font-size: 12px;" onclick="copyCode()">Нажми чтобы скопировать ID</span>
        </div>

        <div class="user-panel">
            <div style="flex:1; font-weight:bold; font-size:14px; white-space: nowrap; overflow: hidden;" id="myDisplayName">User</div>
            
            <button class="control-btn disabled" id="btnMic" onclick="toggleMic()" title="Включить микрофон">
                <i class="fas fa-microphone-slash"></i>
            </button>
            
            <button class="control-btn disabled" id="btnScreen" onclick="toggleScreen()" title="Включить демонстрацию экрана">
                <i class="fas fa-desktop"></i>
            </button>
        </div>
    </div>

    <div class="chat-main">
        <div class="video-grid" id="videoGrid"></div>

        <div class="messages-area" id="messagesArea">
            <div style="margin-top: auto;"></div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" id="chatInput" class="chat-input" placeholder="Написать сообщение...">
            </div>
        </div>
    </div>

    <script>
        let peer;
        let myId;
        let myName;
        let isHost = false;
        
        // Список подключений (текстовых)
        let dataConnections = []; 
        let hostConn = null; 

        // Медиа
        let localAudioStream = null;
        let localScreenStream = null;
        let currentCalls = []; // Список активных звонков (PeerJS Calls)

        // --- 1. ВХОД БЕЗ ЗАПРОСА ПРАВ ---
        
        function initPeer() {
            myName = document.getElementById('usernameInput').value || "User";
            return new Peer(); 
        }

        function createRoom() {
            if(!document.getElementById('usernameInput').value) return alert("Введите ник!");
            peer = initPeer();
            
            peer.on('open', (id) => {
                myId = id;
                isHost = true;
                enterApp();
                addToUserList(myName + " (Host)");
            });

            // Ждем подключения других
            peer.on('connection', (conn) => {
                setupDataConnection(conn);
            });

            // Ждем звонков (если кто-то включит экран/мик)
            peer.on('call', handleIncomingCall);
        }

        function joinRoom() {
            const hostId = document.getElementById('joinCodeInput').value;
            if(!document.getElementById('usernameInput').value || !hostId) return alert("Введите данные!");
            
            peer = initPeer();

            peer.on('open', (id) => {
                myId = id;
                isHost = false;
                enterApp();

                // Соединяемся текстом с хостом
                hostConn = peer.connect(hostId, { metadata: { name: myName } });
                
                hostConn.on('open', () => {
                    addToUserList(myName);
                    addToUserList("Host (Admin)"); // Мы знаем что есть хост
                });

                hostConn.on('data', handleData);
            });

            // Ждем звонков
            peer.on('call', handleIncomingCall);
        }

        function enterApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('myIdDisplay').innerText = myId;
            document.getElementById('myDisplayName').innerText = myName;
        }

        // --- 2. ТЕКСТОВЫЙ ЧАТ ---

        function setupDataConnection(conn) {
            dataConnections.push(conn);
            conn.on('open', () => {
                broadcast({ type: 'system', text: `${conn.metadata.name} зашел в чат` });
            });
            conn.on('data', (data) => {
                handleData(data); // Себе
                broadcast(data);  // Другим
            });
            conn.on('close', () => {
                dataConnections = dataConnections.filter(c => c !== conn);
            });
        }

        function broadcast(data) {
            dataConnections.forEach(c => c.send(data));
        }

        function handleData(data) {
            if (data.type === 'chat') {
                if (data.sender === myName) return; 
                addMessageToUI(data.sender, data.text);
            } 
            else if (data.type === 'system') {
                addSystemMsg(data.text);
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            const msg = { type: 'chat', sender: myName, text: text };
            addMessageToUI(myName, text); 

            if(isHost) broadcast(msg);
            else if(hostConn) hostConn.send(msg);
            
            input.value = '';
        }

        // --- 3. МЕДИА (ПО ЗАПРОСУ) ---

        // Обработка входящего звонка (кто-то стримит или говорит)
        function handleIncomingCall(call) {
            // Отвечаем "пустым" ответом, чтобы просто ПРИНЯТЬ поток
            call.answer(); 
            
            call.on('stream', (remoteStream) => {
                // Определяем, это аудио или видео (экран)
                if(remoteStream.getVideoTracks().length > 0) {
                    addVideoCard(remoteStream, call.peer); // Показать экран
                } else {
                    playAudio(remoteStream); // Воспроизвести голос
                }
            });
        }

        // Включить МИКРОФОН
        async function toggleMic() {
            const btn = document.getElementById('btnMic');
            
            if (localAudioStream) {
                // Выключаем
                localAudioStream.getTracks().forEach(t => t.stop());
                localAudioStream = null;
                btn.className = "control-btn disabled";
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                closeAllCalls(); // Сбрасываем звонки
            } else {
                // Включаем
                try {
                    localAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    btn.className = "control-btn active";
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    
                    // Звоним всем доступным юзерам
                    callEveryone(localAudioStream);
                } catch(e) {
                    alert("Ошибка доступа к микрофону");
                }
            }
        }

        // Включить ЭКРАН
        async function toggleScreen() {
            const btn = document.getElementById('btnScreen');

            if (localScreenStream) {
                // Выключаем
                stopScreenShare();
            } else {
                // Включаем
                try {
                    localScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    btn.className = "control-btn active";
                    
                    // Показываем экран СЕБЕ тоже
                    addVideoCard(localScreenStream, "Me");
                    
                    // Звоним всем
                    callEveryone(localScreenStream);

                    // Если нажали "стоп" в браузере
                    localScreenStream.getVideoTracks()[0].onended = stopScreenShare;

                } catch(e) {
                    console.error(e);
                }
            }
        }

        function stopScreenShare() {
            if(!localScreenStream) return;
            localScreenStream.getTracks().forEach(t => t.stop());
            localScreenStream = null;
            
            document.getElementById('btnScreen').className = "control-btn disabled";
            
            // Удаляем свое видео
            const myVid = document.getElementById('vid-Me');
            if(myVid) myVid.remove();
            checkGridEmpty();
            
            // Перезагрузка звонков (самый простой способ остановить стрим у других в P2P - разорвать связь)
            closeAllCalls();
            
            // Если микрофон был включен, нужно перезвонить с микрофоном
            if(localAudioStream) callEveryone(localAudioStream); 
        }

        // Вспомогательная: Позвонить всем, кого знаем
        function callEveryone(stream) {
            // В этой простой реализации мы используем список dataConnections для поиска PeerID
            // В реальном P2P Mesh нужно хранить список всех ID. 
            // Тут мы упростим: Гость звонит Хосту. Хост звонит всем подключенным гостям.
            
            if (isHost) {
                dataConnections.forEach(conn => {
                    const call = peer.call(conn.peer, stream);
                    currentCalls.push(call);
                });
            } else {
                if(hostConn) {
                    const call = peer.call(hostConn.peer, stream);
                    currentCalls.push(call);
                }
            }
        }

        function closeAllCalls() {
            currentCalls.forEach(call => call.close());
            currentCalls = [];
        }

        // --- 4. UI VODEO ---

        function addVideoCard(stream, peerId) {
            const grid = document.getElementById('videoGrid');
            grid.classList.add('show');

            if(document.getElementById(`vid-${peerId}`)) return; // Уже есть

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `vid-${peerId}`;

            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.playsInline = true;
            if(peerId === "Me") vid.muted = true; // Себя не слышим

            const label = document.createElement('div');
            label.className = 'video-name';
            label.innerText = peerId === "Me" ? "Мой экран" : "Экран собеседника";

            card.appendChild(vid);
            card.appendChild(label);
            grid.appendChild(card);
        }

        function playAudio(stream) {
            // Аудио не требует визуального элемента, но нужен объект Audio
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();
        }

        function checkGridEmpty() {
            const grid = document.getElementById('videoGrid');
            if(grid.children.length === 0) grid.classList.remove('show');
        }

        // --- UI UTILS ---
        function addMessageToUI(sender, text) {
            const area = document.getElementById('messagesArea');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <div class="msg-avatar" style="background: ${stringToColor(sender)}"></div>
                <div style="flex:1">
                    <div class="msg-header">
                        <span class="msg-username">${sender}</span>
                        <span style="font-size:11px; color:#72767d">${new Date().toLocaleTimeString().slice(0,5)}</span>
                    </div>
                    <div class="msg-text">${text}</div>
                </div>
            `;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function addSystemMsg(text) {
            document.getElementById('messagesArea').innerHTML += `<div style="color:#72767d; font-size:12px; margin:5px 0; text-align:center;">${text}</div>`;
        }

        function addToUserList(name) {
            const list = document.getElementById('userList');
            list.innerHTML += `<div style="margin-bottom:5px;"><i class="fas fa-user-circle"></i> ${name}</div>`;
        }

        function copyCode() {
            navigator.clipboard.writeText(myId);
            alert("ID скопирован!");
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return '#' + '00000'.substring(0, 6 - (hash & 0x00FFFFFF).toString(16).toUpperCase().length) + (hash & 0x00FFFFFF).toString(16).toUpperCase();
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>
