<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Discord Mobile Zoom</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #202225;
            --bg-chat: #36393f;
            --bg-header: #2f3136;
            --accent: #5865f2;
            --text: #dcddde;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-chat); color: var(--text);
            height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .app-header {
            height: 60px; background: var(--bg-header); border-bottom: 1px solid #202225;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 10;
        }
        .header-controls { display: flex; gap: 10px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: rgba(0,0,0,0.3); color: var(--text);
            display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer;
        }
        .icon-btn.active { background: var(--accent); color: white; }

        /* --- VIDEO CONTAINER (ZOOMABLE) --- */
        #videoContainer {
            background: black; width: 100%; height: 0; transition: height 0.3s ease;
            overflow: hidden; /* Важно: скрываем то, что вылезает при зуме */
            display: flex; position: relative; z-index: 5;
        }
        #videoContainer.has-video { height: 40vh; border-bottom: 1px solid #202225; }

        /* Обертка для видео нужна для правильного позиционирования */
        .video-wrapper {
            width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; touch-action: none; /* Отключаем стандартный скролл браузера на видео */
        }

        video { 
            max-width: 100%; max-height: 100%; object-fit: contain; 
            transform-origin: center center;
            /* Плавность только для колесика, для пальцев отключаем JS-ом */
            transition: transform 0.1s linear; 
            cursor: grab;
        }
        video:active { cursor: grabbing; }

        /* --- CHAT --- */
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message { display: flex; gap: 10px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
        .username { font-weight: bold; font-size: 14px; }
        .text { color: #dcddde; font-size: 15px; word-wrap: break-word; }

        /* --- INPUT --- */
        .input-bar { padding: 10px; background: var(--bg-chat); display: flex; gap: 10px; border-top: 1px solid #26272d; }
        .chat-input { flex: 1; background: #40444b; border: none; border-radius: 20px; padding: 10px 15px; color: white; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--accent); color: white; }

        /* --- MENU --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: 80%; max-width: 280px;
            background: var(--bg-dark); z-index: 100; transform: translateX(-100%); transition: 0.3s;
            padding: 20px; color: white;
        }
        .sidebar.active { transform: translateX(0); }

        /* --- LOGIN --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-chat); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
        .login-input { padding: 15px; margin: 10px 0; width: 100%; max-width: 300px; background: #202225; border: 1px solid #111; color: white; border-radius: 5px; }
        .btn-main { padding: 15px; width: 100%; max-width: 300px; background: var(--accent); color: white; border: none; border-radius: 5px; font-weight: bold; }
        
        .zoom-hint {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px;
            font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h2 style="color:white; margin-bottom:20px;">Zoom & Chat</h2>
        <input type="text" id="nickInput" class="login-input" placeholder="Никнейм">
        <button class="btn-main" onclick="createRoom()">Создать комнату</button>
        <p style="color:#777; margin:15px;">— ИЛИ —</p>
        <input type="text" id="codeInput" class="login-input" placeholder="Код комнаты">
        <button class="btn-main" style="background:#4f545c;" onclick="joinRoom()">Войти</button>
    </div>

    <header class="app-header">
        <button onclick="toggleMenu()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-bars"></i></button>
        <div class="header-controls">
            <button class="icon-btn" id="btnMic" onclick="toggleMic()"><i class="fas fa-microphone-slash"></i></button>
            <button class="icon-btn" id="btnScreen" onclick="toggleScreen()"><i class="fas fa-desktop"></i></button>
        </div>
    </header>

    <div id="videoContainer">
        <div class="zoom-hint" id="zoomHint">x1.0</div>
    </div>

    <div class="chat-area" id="chatArea">
        <div style="text-align:center; color:#555; font-size:13px; margin-top:20px;">Добро пожаловать. Меню слева сверху.</div>
    </div>

    <div class="input-bar">
        <input type="text" id="msgInput" class="chat-input" placeholder="Сообщение...">
        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-arrow-up"></i></button>
    </div>

    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="sidebar" id="sidebar">
        <h3>Меню</h3>
        <p style="font-size:12px; color:#aaa;">ВАШ ID:</p>
        <div id="myIdDisplay" style="background:#111; padding:10px; font-family:monospace; margin-bottom:10px;" onclick="copyId()">...</div>
        <div id="userList"></div>
    </div>

    <script>
        let peer, myId, myName;
        let connections = [], hostConn = null, isHost = false;
        let localStream = null, currentCalls = [];

        // --- P2P BASIC ---
        function initPeer() {
            myName = document.getElementById('nickInput').value || "User";
            return new Peer();
        }
        function createRoom() {
            if(!document.getElementById('nickInput').value) return alert("Введите имя");
            peer = initPeer();
            peer.on('open', id => { myId=id; isHost=true; startApp(); });
            peer.on('connection', setupConn);
            peer.on('call', handleCall);
        }
        function joinRoom() {
            const code = document.getElementById('codeInput').value;
            if(!code) return alert("Введите код");
            peer = initPeer();
            peer.on('open', id => {
                myId=id; isHost=false; startApp();
                hostConn = peer.connect(code, {metadata:{name:myName}});
                hostConn.on('data', handleData);
            });
            peer.on('call', handleCall);
        }
        function startApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('myIdDisplay').innerText = myId;
        }

        // --- CHAT ---
        function setupConn(conn) {
            connections.push(conn);
            conn.on('data', data => { handleData(data); broadcast(data); });
            conn.on('open', () => broadcast({type:'sys', text: conn.metadata.name + ' вошел'}));
        }
        function broadcast(data) { connections.forEach(c => c.send(data)); }
        function handleData(data) {
            if(data.type === 'chat' && data.sender !== myName) addMessage(data.sender, data.text);
            if(data.type === 'sys') addMessage('System', data.text);
        }
        function sendMessage() {
            const txt = document.getElementById('msgInput').value;
            if(!txt) return;
            addMessage(myName, txt);
            const msg = {type:'chat', sender:myName, text:txt};
            if(isHost) broadcast(msg); else if(hostConn) hostConn.send(msg);
            document.getElementById('msgInput').value = '';
        }

        // --- MEDIA ---
        function handleCall(call) {
            call.answer();
            call.on('stream', stream => addVideo(stream));
        }
        async function toggleScreen() {
            try {
                // Просим браузер дать максимальное качество
                localStream = await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always", width:1920}});
                document.getElementById('btnScreen').classList.add('active');
                
                // Показываем себе и звоним всем
                addVideo(localStream);
                if(isHost) connections.forEach(c => peer.call(c.peer, localStream));
                else if(hostConn) peer.call(hostConn.peer, localStream);
                
                // Очистка при остановке
                localStream.getVideoTracks()[0].onended = () => {
                    document.getElementById('videoContainer').innerHTML = '';
                    document.getElementById('videoContainer').classList.remove('has-video');
                    document.getElementById('btnScreen').classList.remove('active');
                };
            } catch(e) { console.log(e); }
        }

        // --- ГЛАВНАЯ ФУНКЦИЯ ЗУМА (ZOOM & PAN) ---
        function addVideo(stream) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = ''; // Показываем только 1 стрим (активный)
            container.classList.add('has-video');

            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            
            wrapper.appendChild(video);
            container.appendChild(wrapper);

            // ПОДКЛЮЧАЕМ ЛОГИКУ ЗУМА
            enableZoomPan(video, wrapper);
        }

        function enableZoomPan(videoElement, wrapperElement) {
            let scale = 1;
            let pointX = 0;
            let pointY = 0;
            let startX = 0;
            let startY = 0;
            let isDragging = false;
            
            // Ограничения зума
            const minScale = 1;
            const maxScale = 5;

            // Обновление CSS
            const updateTransform = () => {
                // Ограничиваем выход за границы при зуме
                // (упрощенная логика: просто не даем улететь слишком далеко)
                videoElement.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                
                // Показать хинт с уровнем зума
                const hint = document.getElementById('zoomHint');
                hint.innerText = `x${scale.toFixed(1)}`;
                hint.style.opacity = '1';
                clearTimeout(window.zoomTimeout);
                window.zoomTimeout = setTimeout(() => hint.style.opacity = '0', 1500);
            };

            // --- DESKTOP (MOUSE WHEEL) ---
            wrapperElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const newScale = Math.min(Math.max(minScale, scale + delta), maxScale);
                
                if (newScale === 1) { pointX = 0; pointY = 0; } // Сброс позиции при отдалении
                scale = newScale;
                updateTransform();
            });

            // --- DESKTOP (DRAG) ---
            wrapperElement.addEventListener('mousedown', (e) => {
                if (scale > 1) {
                    isDragging = true;
                    startX = e.clientX - pointX;
                    startY = e.clientY - pointY;
                    videoElement.style.transition = 'none'; // Убираем плавность для драга
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    pointX = e.clientX - startX;
                    pointY = e.clientY - startY;
                    updateTransform();
                }
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                videoElement.style.transition = 'transform 0.1s linear'; // Возвращаем плавность
            });

            // --- MOBILE (PINCH & PAN) ---
            let initialDist = 0;
            let initialScale = 1;
            
            wrapperElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    // Начало щипка
                    initialDist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialScale = scale;
                    videoElement.style.transition = 'none'; // Убираем лаги
                } else if (e.touches.length === 1 && scale > 1) {
                    // Начало перемещения (pan)
                    isDragging = true;
                    startX = e.touches[0].clientX - pointX;
                    startY = e.touches[0].clientY - pointY;
                    videoElement.style.transition = 'none';
                }
            });

            wrapperElement.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    // ЗУМ
                    e.preventDefault(); // Чтобы не скроллилась страница
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    
                    // Формула зума
                    const newScale = initialScale * (dist / initialDist);
                    scale = Math.min(Math.max(minScale, newScale), maxScale);
                    updateTransform();
                } else if (e.touches.length === 1 && scale > 1 && isDragging) {
                    // ПЕРЕМЕЩЕНИЕ
                    e.preventDefault();
                    pointX = e.touches[0].clientX - startX;
                    pointY = e.touches[0].clientY - startY;
                    updateTransform();
                }
            });

            wrapperElement.addEventListener('touchend', (e) => {
                isDragging = false;
                if (e.touches.length < 2) {
                    videoElement.style.transition = 'transform 0.1s linear';
                    if (scale < 1.1) { // Если почти 1, сбрасываем в ноль
                        scale = 1; pointX = 0; pointY = 0;
                        updateTransform();
                    }
                }
            });
        }

        /* --- UI HELPERS --- */
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }
        function addMessage(sender, text) {
            const chat = document.getElementById('chatArea');
            chat.innerHTML += `<div class="message"><div class="avatar"></div><div><div class="username">${sender}</div><div class="text">${text}</div></div></div>`;
            chat.scrollTop = chat.scrollHeight;
        }
        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("Скопировано");
        }
        
        // Микрофон заглушка
        function toggleMic() {
             document.getElementById('btnMic').classList.toggle('active');
        }

    </script>
</body>
</html>
