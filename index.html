<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Group Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --accent: #5865f2;
            --danger: #ed4245;
            --message-hover: #32353b;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-normal); overflow: hidden; display: flex; height: 100vh; }

        /* --- ЛОГИН (МОДАЛЬНОЕ ОКНО) --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--bg-secondary); padding: 40px; border-radius: 5px; width: 400px; text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .login-input {
            width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-tertiary);
            border: 1px solid #202225; color: white; border-radius: 3px; font-size: 16px;
        }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 3px; color: white;
            font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; font-size: 14px;
        }
        .btn-blue { background: var(--accent); }
        .btn-blue:hover { background: #4752c4; }
        .btn-gray { background: #4f545c; }
        .btn-gray:hover { background: #686d73; }
        
        .divider { margin: 20px 0; color: var(--text-muted); font-size: 12px; font-weight: bold; display: flex; align-items: center; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #4f545c; }
        .divider::before { margin-right: 10px; } .divider::after { margin-left: 10px; }

        /* --- ОСНОВНОЙ ИНТЕРФЕЙС --- */
        /* 1. Левая полоска серверов */
        .servers-nav { width: 72px; background: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .server-icon { width: 48px; height: 48px; background: var(--bg-primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .server-icon:hover { border-radius: 16px; background: var(--accent); }
        .server-icon.active { border-radius: 16px; background: var(--accent); }

        /* 2. Список участников (Сайдбар) */
        .sidebar { width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; }
        .channel-header { height: 48px; border-bottom: 1px solid #202225; display: flex; align-items: center; padding: 0 16px; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); }
        
        .members-list { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .member-category { font-size: 12px; color: var(--text-muted); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        
        .member-item { display: flex; align-items: center; padding: 6px; border-radius: 4px; color: var(--text-muted); cursor: pointer; }
        .member-item:hover { background: rgba(79,84,92,0.32); color: var(--text-normal); }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: #faa61a; position: relative; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); position: absolute; bottom: -2px; right: -2px; border: 3px solid var(--bg-secondary); }
        .member-name { font-weight: 500; }

        /* Код комнаты внизу */
        .room-code-panel { background: #202225; padding: 10px; text-align: center; }
        .code-display { font-family: monospace; background: black; padding: 5px; border-radius: 3px; cursor: pointer; user-select: all; color: var(--success); font-size: 14px;}
        
        /* 3. Чат */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative;}
        .chat-header { height: 48px; border-bottom: 1px solid #26272d; display: flex; align-items: center; padding: 0 16px; font-weight: bold; }
        
        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; margin-bottom: 5px; }
        .message:hover { background: rgba(4, 4, 5, 0.07); }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; background: #faa61a; margin-right: 16px; flex-shrink: 0; cursor: pointer; }
        .msg-content { flex: 1; }
        .msg-header { display: flex; align-items: center; margin-bottom: 2px; }
        .msg-username { font-weight: 500; margin-right: 8px; cursor: pointer; }
        .msg-username:hover { text-decoration: underline; }
        .msg-time { font-size: 11px; color: var(--text-muted); }
        .msg-text { color: var(--text-normal); white-space: pre-wrap; word-wrap: break-word; line-height: 1.4; }

        .input-area { padding: 0 16px 24px; margin-top: 10px; }
        .input-wrapper { background: #40444b; border-radius: 8px; padding: 10px; display: flex; align-items: center; }
        .chat-input { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 15px; }

        /* Видео/Голос (Скрытые элементы) */
        #audioContainer { display: none; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <i class="fab fa-discord fa-3x" style="color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="color: white; margin-bottom: 5px;">Добро пожаловать</h2>
            <p style="color: #b9bbbe; font-size: 14px;">Придумайте ник и создайте группу</p>
            
            <input type="text" id="usernameInput" class="login-input" placeholder="Ваш никнейм" maxlength="15">
            
            <button class="btn btn-blue" onclick="createRoom()">Создать свою группу</button>
            
            <div class="divider">ИЛИ ПРИСОЕДИНИТЕСЬ</div>
            
            <input type="text" id="joinCodeInput" class="login-input" placeholder="Введите код группы...">
            <button class="btn btn-gray" onclick="joinRoom()">Присоединиться</button>
            
            <p id="statusMsg" style="color: var(--danger); margin-top: 10px; font-size: 13px;"></p>
        </div>
    </div>

    <div class="servers-nav">
        <div class="server-icon active"><i class="fab fa-discord"></i></div>
        <div class="server-icon"><i class="fas fa-plus"></i></div>
    </div>

    <div class="sidebar">
        <div class="channel-header">Групповой чат</div>
        <div class="members-list">
            <div class="member-category">УЧАСТНИКИ — <span id="memberCount">1</span></div>
            <div id="membersContainer">
                </div>
        </div>
        
        <div class="room-code-panel">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">КОД ДЛЯ ДРУЗЕЙ:</div>
            <div id="myIdDisplay" class="code-display" onclick="copyCode()" title="Нажми чтобы скопировать">...</div>
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <i class="fas fa-hashtag" style="color: var(--text-muted); margin-right: 10px;"></i>
            general
        </div>

        <div class="messages-area" id="messagesArea">
            <div style="margin-top: auto;">
                <h1 style="color: white; font-weight: bold;">Добро пожаловать в #general</h1>
                <p style="color: var(--text-muted);">Это начало истории этого канала.</p>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <i class="fas fa-plus-circle" style="color: var(--text-muted); margin-right: 15px; cursor: pointer;"></i>
                <input type="text" id="chatInput" class="chat-input" placeholder="Написать сообщение..." autocomplete="off">
            </div>
        </div>
    </div>
    
    <div id="audioContainer"></div>

    <script>
        let peer = null;
        let myName = "Anon";
        let myId = "";
        let connections = []; // Список подключений (для Админа)
        let hostConnection = null; // Подключение к Админу (для Гостя)
        let isHost = false;

        const colors = ['#faa61a', '#ed4245', '#3ba55c', '#5865f2', '#eb459e'];

        // --- 1. ЛОГИКА ВХОДА ---

        function initPeer() {
            myName = document.getElementById('usernameInput').value || "User" + Math.floor(Math.random()*100);
            return new Peer(); 
        }

        // Создать комнату (Я - Админ)
        function createRoom() {
            if(!document.getElementById('usernameInput').value) {
                document.getElementById('statusMsg').innerText = "Введите никнейм!";
                return;
            }

            peer = initPeer();
            isHost = true;

            peer.on('open', (id) => {
                myId = id;
                enterApp();
                addSystemMessage(`Группа создана! Отправьте код друзьям: ${id}`);
                addMemberToSidebar(myName, true); // Добавляем себя
            });

            // Когда кто-то подключается к Админу
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
        }

        // Присоединиться (Я - Гость)
        function joinRoom() {
            const code = document.getElementById('joinCodeInput').value.trim();
            if(!code || !document.getElementById('usernameInput').value) {
                document.getElementById('statusMsg').innerText = "Введите ник и код!";
                return;
            }

            peer = initPeer();
            isHost = false;

            peer.on('open', (id) => {
                myId = id;
                enterApp();
                // Соединяемся с Админом
                const conn = peer.connect(code, { metadata: { name: myName } });
                
                conn.on('open', () => {
                    hostConnection = conn;
                    addSystemMessage("Вы подключились к группе!");
                    
                    // Слушаем сообщения от Админа
                    conn.on('data', (data) => handleData(data));
                });

                conn.on('close', () => alert("Админ отключился, чат закрыт."));
            });
        }

        function enterApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('myIdDisplay').innerText = myId;
        }

        // --- 2. ОБРАБОТКА ПОДКЛЮЧЕНИЙ (ТОЛЬКО ДЛЯ АДМИНА) ---
        
        function setupConnection(conn) {
            connections.push(conn);
            
            conn.on('open', () => {
                // 1. Отправляем новому участнику историю или приветствие (опционально)
                // 2. Оповещаем всех, что кто-то зашел
                broadcast({ type: 'system', text: `${conn.metadata.name} присоединился.` });
                
                // Обновляем список участников всем
                updateAllClientsUserList();
            });

            conn.on('data', (data) => {
                // Админ получил сообщение от Гостя
                // Админ должен показать его у себя и переслать ВСЕМ остальным
                handleData(data); // Показываем у себя
                broadcast(data);  // Рассылаем остальным
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                broadcast({ type: 'system', text: `${conn.metadata.name} вышел.` });
                updateAllClientsUserList();
            });
        }

        // --- 3. РАССЫЛКА И ОБРАБОТКА ДАННЫХ ---

        // Отправить всем (функция Админа)
        function broadcast(data) {
            connections.forEach(c => c.send(data));
        }

        // Обработка входящих данных (и Админ, и Гость)
        function handleData(data) {
            if (data.type === 'message') {
                addMessageToChat(data.sender, data.text);
            } 
            else if (data.type === 'system') {
                addSystemMessage(data.text);
            }
            else if (data.type === 'userlist') {
                // Пришел обновленный список людей от Админа
                renderUserList(data.users);
            }
        }

        // --- 4. ОТПРАВКА СООБЩЕНИЙ ---

        const input = document.getElementById('chatInput');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                sendMessage();
            }
        });

        function sendMessage() {
            const text = input.value;
            const msgData = { type: 'message', sender: myName, text: text };

            // Показываем у себя сразу
            addMessageToChat(myName, text);

            if (isHost) {
                // Если я Админ -> рассылаем всем
                broadcast(msgData);
            } else {
                // Если я Гость -> шлем Админу (а он разошлет)
                if (hostConnection) hostConnection.send(msgData);
            }

            input.value = '';
        }

        // --- 5. ФУНКЦИИ ИНТЕРФЕЙСА ---

        function addMessageToChat(sender, text) {
            const area = document.getElementById('messagesArea');
            const color = colors[Math.abs(sender.length) % colors.length]; // Случайный цвет по длине имени
            
            const html = `
                <div class="message">
                    <div class="msg-avatar" style="background: ${color}"></div>
                    <div class="msg-content">
                        <div class="msg-header">
                            <span class="msg-username">${sender}</span>
                            <span class="msg-time">${new Date().toLocaleTimeString().slice(0,5)}</span>
                        </div>
                        <div class="msg-text">${text}</div>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', html);
            area.scrollTop = area.scrollHeight;
        }

        function addSystemMessage(text) {
            const area = document.getElementById('messagesArea');
            area.insertAdjacentHTML('beforeend', `<div style="color:#72767d; font-size:12px; margin:5px 0; padding-left:56px;"><i class="fas fa-arrow-right"></i> ${text}</div>`);
            area.scrollTop = area.scrollHeight;
        }

        // Обновление списка участников (Логика Админа)
        function updateAllClientsUserList() {
            // Собираем всех: Я (Админ) + Все подключения
            let allUsers = [myName];
            connections.forEach(c => {
                if(c.metadata && c.metadata.name) allUsers.push(c.metadata.name);
            });

            // Отображаем у себя
            renderUserList(allUsers);

            // Рассылаем всем новый список
            broadcast({ type: 'userlist', users: allUsers });
        }

        function renderUserList(names) {
            const container = document.getElementById('membersContainer');
            document.getElementById('memberCount').innerText = names.length;
            container.innerHTML = '';
            
            names.forEach(name => {
                addMemberToSidebar(name);
            });
        }

        function addMemberToSidebar(name) {
            const container = document.getElementById('membersContainer');
            const color = colors[Math.abs(name.length) % colors.length];
            const html = `
                <div class="member-item">
                    <div class="member-avatar" style="background: ${color}">
                        <div class="status-dot"></div>
                    </div>
                    <div class="member-name">${name}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function copyCode() {
            navigator.clipboard.writeText(myId);
            const el = document.getElementById('myIdDisplay');
            const old = el.innerText;
            el.innerText = "СКОПИРОВАНО!";
            el.style.color = "white";
            setTimeout(() => {
                el.innerText = old;
                el.style.color = "var(--success)";
            }, 1500);
        }

        // Защита от закрытия вкладки
        window.onbeforeunload = function() {
            return "Если вы выйдете, чат прервется. Вы уверены?";
        };

    </script>
</body>
</html>
